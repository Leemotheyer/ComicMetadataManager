{% extends "base.html" %}

{% block title %}Volume {{ volume_id }} - Comic Metadata Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Volume Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-book-open me-2"></i>{{ volume.volume_folder if volume.volume_folder else 'Volume ' + volume_id|string }}</h1>
                </div>
                <div>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Volumes
                    </a>
                </div>
            </div>
        </div>
    </div>

                                                     <!-- Volume Information and Status -->
         <div class="row mb-4">
             <div class="col-md-8">
                 <div class="card">
                     <div class="card-body p-0">
                         <div class="d-flex">
                             <div class="cover-image-container-large">
                                 <div class="cover-loading-large">
                                     <div class="spinner-border text-primary" role="status">
                                         <span class="visually-hidden">Loading...</span>
                                     </div>
                                 </div>
                                 <img src="http://192.168.1.205:5656/api/volumes/{{ volume_id }}/cover?api_key={{ config.KAPOWARR_API_KEY if config.KAPOWARR_API_KEY else 'ebc7ae18fc51185122967f05727bf003' }}" 
                                      class="cover-image-large" 
                                      alt="Cover for {{ volume.volume_folder if volume.volume_folder else 'Volume ' + volume_id|string }}"
                                      onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';"
                                      onerror="this.style.display='none'; this.previousElementSibling.style.display='none'; this.nextElementSibling.style.display='block';">
                                 <div class="no-cover-placeholder-large" style="display: none;">
                                     <i class="fas fa-book fa-4x text-muted"></i>
                                     <p class="text-muted mt-3">No Cover Available</p>
                                 </div>
                             </div>
                             <div class="flex-grow-1 p-4">
                                 <div class="row">
                                     <div class="col-md-6">
                                         <h5><i class="fas fa-info-circle me-2"></i>Volume Information</h5>
                                         <table class="table table-borderless">
                                             <tr>
                                                 <td><strong>Volume ID:</strong></td>
                                                 <td>{{ volume.id if volume.id else 'Unknown' }}</td>
                                             </tr>
                                             <tr>
                                                 <td><strong>Folder:</strong></td>
                                                 <td>{{ volume.volume_folder if volume.volume_folder else 'Unknown' }}</td>
                                             </tr>
                                                                                           <tr>
                                                  <td><strong>Issue Count:</strong></td>
                                                  <td>{{ volume.issue_count if volume.issue_count else 'Unknown' }}</td>
                                              </tr>
                                                                                             <tr>
                                                   <td><strong>ComicVine ID:</strong></td>
                                                   <td>
                                                       {% if volume.comicvine_id %}
                                                           <a href="https://comicvine.gamespot.com/volume/4050-{{ volume.comicvine_id }}/" 
                                                              target="_blank" 
                                                              class="badge bg-info text-decoration-none">
                                                                {{ volume.comicvine_id }}
                                                            </a>
                                                       {% else %}
                                                           <span class="badge bg-warning">No ComicVine ID</span>
                                                       {% endif %}
                                                   </td>
                                               </tr>
                                               <tr>
                                                   <td><strong>Kapowarr Link:</strong></td>
                                                   <td>
                                                       <a href="{{ config.KAPOWARR_URL if config.KAPOWARR_URL else 'http://192.168.1.205:5656' }}/volumes/{{ volume_id }}" 
                                                          target="_blank" 
                                                          class="badge bg-primary text-decoration-none">
                                                            View in Kapowarr
                                                        </a>
                                                   </td>
                                               </tr>
                                              <tr>
                                                  <td><strong>Status:</strong></td>
                                                  <td>
                                                      <span class="badge bg-success">Available</span>
                                                  </td>
                                              </tr>
                                         </table>
                                     </div>
                                     <div class="col-md-6">
                                         <h5><i class="fas fa-tools me-2"></i>Actions</h5>
                                         <div class="d-grid gap-2">
                                             <button class="btn btn-primary btn-lg" onclick="processMetadataAndInject()">
                                                 <i class="fas fa-magic me-2"></i>Add Metadata for all issues
                                             </button>
                                                                                           <button class="btn btn-warning" onclick="refreshVolume()">
                                                  <i class="fas fa-sync-alt me-2"></i>Refresh Volume Data
                                              </button>
                                              <button class="btn btn-info" onclick="cleanupTempDirectories()">
                                                  <i class="fas fa-broom me-2"></i>Cleanup Temp Files
                                              </button>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="col-md-4">
                 <div class="card">
                     <div class="card-header">
                         <h5><i class="fas fa-chart-line me-2"></i>Status & Progress</h5>
                     </div>
                     <div class="card-body">
                         <div id="statusInfo">
                             <p class="text-muted mb-0">Ready to process volume</p>
                         </div>
                     </div>
                 </div>
             </div>
         </div>

        <!-- Issues List -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list me-2"></i>Issues in Volume</h5>
                        <span class="badge bg-secondary">{{ volume.issues|length if volume.issues else 0 }} issues</span>
                    </div>
                    <div class="card-body">
                        <div id="loadingIndicator" class="loading text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading issues...</p>
                        </div>
                        
                        <div id="issuesContainer">
                            {% if volume.issues %}
                                <div class="row">
                                    {% for issue in volume.issues %}
                                                                         <div class="col-md-6 col-lg-4 mb-3">
                                         <div class="card issue-card h-100 {% if issue.files and issue.files|length > 0 %}border-success{% else %}border-danger{% endif %}">
                                            <div class="card-body">
                                                <h6 class="card-title">Issue {{ issue.issue_number if issue.issue_number else 'Unknown' }}</h6>
                                                <p class="card-text text-muted">
                                                    {{ issue.title if issue.title else 'No title' }}
                                                </p>
                                                                                                 <div class="mb-2">
                                                     {% if issue.comicvine_id %}
                                                         <a href="https://comicvine.gamespot.com/issue/4000-{{ issue.comicvine_id }}/" 
                                                            target="_blank" 
                                                            class="badge bg-success text-decoration-none">
                                                             ComicVine ID: {{ issue.comicvine_id }}
                                                         </a>
                                                     {% else %}
                                                         <span class="badge bg-warning">No ComicVine ID</span>
                                                     {% endif %}
                                                 </div>
                                                                                                 <div class="mt-2">
                                                     <small class="text-muted">
                                                         <strong>Files:</strong>
                                                         {% if issue.files and issue.files|length > 0 %}
                                                             {% for file in issue.files %}
                                                                 <div class="text-truncate" title="{{ file.filepath }}">
                                                                     {{ file.filepath.split('/')[-1] if '/' in file.filepath else file.filepath }}
                                                                 </div>
                                                             {% endfor %}
                                                         {% else %}
                                                             <span class="text-muted">No files</span>
                                                         {% endif %}
                                                     </small>
                                                 </div>
                                                 
                                                 <!-- Issue Actions -->
                                                 <div class="mt-3">
                                                     {% if issue.files and issue.files|length > 0 and issue.comicvine_id %}
                                                         <button class="btn btn-sm btn-primary w-100 process-issue-btn"
                                                                 data-volume-id="{{ volume_id }}"
                                                                 data-issue-index="{{ loop.index0 }}"
                                                                 data-issue-number="{{ issue.issue_number if issue.issue_number else 'Unknown' }}">
                                                             <i class="fas fa-download me-1"></i>Add metadata
                                                         </button>
                                                         <div class="mt-2">
                                                             <small class="text-muted issue-status" id="issue-status-{{ loop.index0 }}">
                                                                 Ready to process
                                                             </small>
                                                         </div>
                                                         <!-- Metadata Info (hidden by default) -->
                                                         <div class="mt-2 metadata-info" id="metadata-info-{{ loop.index0 }}" style="display: none;">
                                                             <small class="text-success">
                                                                 <i class="fas fa-info-circle me-1"></i>
                                                                 <span class="metadata-summary">Metadata available</span>
                                                             </small>
                                                         </div>
                                                     {% elif issue.files and issue.files|length > 0 %}
                                                         <button class="btn btn-sm btn-secondary w-100" disabled>
                                                             <i class="fas fa-exclamation-triangle me-1"></i>No ComicVine ID
                                                         </button>
                                                     {% else %}
                                                         <button class="btn btn-sm btn-secondary w-100" disabled>
                                                             <i class="fas fa-exclamation-triangle me-1"></i>No Files
                                                         </button>
                                                     {% endif %}
                                                 </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted text-center py-4">No issues found in this volume</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Toast for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
            </div>
        </div>
    </div>

    <!-- Pass configuration to JavaScript -->
    <script>
        window.KAPOWARR_API_KEY = '{{ config.KAPOWARR_API_KEY if config.KAPOWARR_API_KEY else "" }}';
        window.KAPOWARR_URL = '{{ config.KAPOWARR_URL if config.KAPOWARR_URL else "http://192.168.1.205:5656" }}';
    </script>

    <!-- Volume-specific JavaScript -->
    <script src="{{ url_for('static', filename='js/volume-detail.js') }}"></script>
{% endblock %}
