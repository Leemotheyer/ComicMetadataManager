{% extends "base.html" %}

{% block title %}Settings - Comic Metadata Manager{% endblock %}

{% block content %}
<div class="container-fluid">

        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-cog me-2"></i>Settings</h1>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Home
                    </a>
                </div>

                <!-- Settings Form -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-key me-2"></i>API Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="settingsForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="kapowarrUrl" class="form-label">
                                            <i class="fas fa-server me-1"></i>Kapowarr URL
                                        </label>
                                        <input type="url" class="form-control" id="kapowarrUrl" name="kapowarr_url" 
                                               value="{{ settings.kapowarr_url or 'http://192.168.1.205:5656' }}" 
                                               placeholder="http://192.168.1.205:5656" required>
                                        <div class="form-text">The base URL for your Kapowarr instance</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="kapowarrApiKey" class="form-label">
                                            <i class="fas fa-key me-1"></i>Kapowarr API Key
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="kapowarrApiKey" name="kapowarr_api_key" 
                                                   value="{{ settings.kapowarr_api_key or '' }}" 
                                                   placeholder="Enter your Kapowarr API key" required>
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('kapowarrApiKey')">
                                                <i class="fas fa-eye" id="kapowarrApiKeyIcon"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Your Kapowarr API key for authentication</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="comicvineApiKey" class="form-label">
                                            <i class="fas fa-key me-1"></i>ComicVine API Key
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="comicvineApiKey" name="comicvine_api_key" 
                                                   value="{{ settings.comicvine_api_key or '' }}" 
                                                   placeholder="Enter your ComicVine API key" required>
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('comicvineApiKey')">
                                                <i class="fas fa-eye" id="comicvineApiKeyIcon"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Your ComicVine API key for metadata retrieval</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="tempDirectory" class="form-label">
                                            <i class="fas fa-folder me-1"></i>Temp Directory
                                        </label>
                                        <input type="text" class="form-control" id="tempDirectory" name="temp_directory" 
                                               value="{{ settings.temp_directory or './temp' }}" 
                                               placeholder="./temp">
                                        <div class="form-text">Directory for temporary files (relative to app directory)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="maxConcurrentTasks" class="form-label">
                                            <i class="fas fa-tasks me-1"></i>Max Concurrent Tasks
                                        </label>
                                        <input type="number" class="form-control" id="maxConcurrentTasks" name="max_concurrent_tasks" 
                                               value="{{ settings.max_concurrent_tasks or 3 }}" 
                                               min="1" max="10">
                                        <div class="form-text">Maximum number of metadata tasks running simultaneously</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="taskTimeout" class="form-label">
                                            <i class="fas fa-clock me-1"></i>Task Timeout (minutes)
                                        </label>
                                        <input type="number" class="form-control" id="taskTimeout" name="task_timeout" 
                                               value="{{ settings.task_timeout or 30 }}" 
                                               min="5" max="120">
                                        <div class="form-text">Maximum time to wait for a task to complete</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="flaskSecretKey" class="form-label">
                                            <i class="fas fa-shield-alt me-1"></i>Flask Secret Key
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="flaskSecretKey" name="flask_secret_key" 
                                                   value="{{ settings.flask_secret_key or '' }}" 
                                                   placeholder="Enter Flask secret key">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('flaskSecretKey')">
                                                <i class="fas fa-eye" id="flaskSecretKeyIcon"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Secret key for Flask session management (change in production)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-warning" onclick="testConnection()">
                                    <i class="fas fa-plug me-1"></i>Test Connection
                                </button>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetToDefaults()">
                                        <i class="fas fa-undo me-1"></i>Reset to Defaults
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-1"></i>Save Settings
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Connection Test Results -->
                <div id="connectionTestResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-plug me-2"></i>Connection Test Results</h5>
                        </div>
                        <div class="card-body" id="connectionTestContent">
                            <!-- Test results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Current Settings Display -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Current Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Kapowarr Settings</h6>
                                <p><strong>URL:</strong> <span id="currentKapowarrUrl">{{ settings.kapowarr_url or 'Not set' }}</span></p>
                                <p><strong>API Key:</strong> <span id="currentKapowarrKey">{{ '••••••••' if settings.kapowarr_api_key else 'Not set' }}</span></p>
                            </div>
                            <div class="col-md-6">
                                <h6>ComicVine Settings</h6>
                                <p><strong>API Key:</strong> <span id="currentComicVineKey">{{ '••••••••' if settings.comicvine_api_key else 'Not set' }}</span></p>
                                <p><strong>Temp Directory:</strong> <span id="currentTempDir">{{ settings.temp_directory or 'Not set' }}</span></p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Application Settings</h6>
                                <p><strong>Max Concurrent Tasks:</strong> <span id="currentMaxTasks">{{ settings.max_concurrent_tasks or 'Not set' }}</span></p>
                                <p><strong>Task Timeout:</strong> <span id="currentTaskTimeout">{{ settings.task_timeout or 'Not set' }} minutes</span></p>
                            </div>
                            <div class="col-md-6">
                                <h6>Security Settings</h6>
                                <p><strong>Flask Secret Key:</strong> <span id="currentFlaskKey">{{ '••••••••' if settings.flask_secret_key else 'Not set' }}</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong id="toastTitle" class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Toast message will be populated here -->
            </div>
        </div>
    </div>

    <!-- Pass configuration to JavaScript -->
    <script>
        window.KAPOWARR_API_KEY = '{{ config.KAPOWARR_API_KEY if config.KAPOWARR_API_KEY else "" }}';
        window.KAPOWARR_URL = '{{ config.KAPOWARR_URL if config.KAPOWARR_URL else "http://192.168.1.205:5652" }}';
    </script>

    <!-- Settings-specific JavaScript -->
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}
